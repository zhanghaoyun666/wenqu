<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é—®é“ - å¤©ä¹™è´µäºº | é—®æ¸ </title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="enhanced-animations.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="page-transition">
    <script>
        // æ–°ä¼šè¯æ£€æµ‹ - åˆ·æ–°æˆ–é‡æ–°æ‰“å¼€ç½‘ç«™æ—¶æ¸…é™¤ç™»å½•çŠ¶æ€å¹¶è¿”å›ä¸»ç•Œé¢
        (function() {
            const isNewSession = !sessionStorage.getItem('wq_session_active');
            const isFromOtherPage = document.referrer && document.referrer.includes(window.location.hostname);
            
            if (isNewSession) {
                sessionStorage.setItem('wq_session_active', 'true');
                if (!isFromOtherPage) {
                    localStorage.removeItem('wq_user');
                    localStorage.removeItem('wq_token');
                    window.location.href = 'main.html';
                    return;
                }
            }
            
            // ç®¡ç†å‘˜ä¸èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½
            const user = JSON.parse(localStorage.getItem('wq_user') || '{}');
            if (user.role === 'admin') {
                alert('ç®¡ç†å‘˜è´¦å·æ— æ³•ä½¿ç”¨æ­¤åŠŸèƒ½');
                window.location.href = 'admin.html';
            }
        })();
    </script>
    <div class="bg-decoration"></div>
    
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <header class="header">
            <h1 class="logo glow-text">é—®æ¸ </h1>
            <p class="subtitle">é—®é“ Â· å¤©ä¹™è´µäºº</p>
        </header>

        <!-- å¯¼èˆª -->
        <nav class="nav">
            <a href="main.html" class="nav-btn" id="homeLink">é¦–é¡µ</a>
            <a href="wendao.html" class="nav-btn active" id="wendaoLink">é—®é“</a>
            <a href="liuyao.html" class="nav-btn" id="liuyaoLink">å…­çˆ»</a>
            <a href="heban.html" class="nav-btn" id="hebanLink">åˆç›˜</a>
            <a href="dashboard.html" class="nav-btn" id="dataLink" style="display: none;">ğŸ“Š æ•°æ®</a>
            <a href="admin.html" class="nav-btn" id="adminLink" style="display: none;">âš™ï¸ ç®¡ç†</a>
            <a href="auth.html" class="nav-btn" id="authLink">ğŸ”‘ ç™»å½•</a>
        </nav>

        <!-- ç™»å½•æ£€æŸ¥æç¤º -->
        <div id="loginRequired" class="card" style="border-color: rgba(255, 100, 100, 0.5); display: none;">
            <h2 class="card-title" style="color: #ff6464;">ğŸ”’ è¯·å…ˆç™»å½•</h2>
            <p style="text-align: center; color: var(--text-secondary); line-height: 2;">
                ä½¿ç”¨é—®é“åŠŸèƒ½éœ€è¦å…ˆç™»å½•è´¦å·<br>
                ç™»å½•åå¯ä»¥ä¿å­˜å†å²è®°å½•ï¼Œéšæ—¶æŸ¥çœ‹è¿‡å¾€å’¨è¯¢
            </p>
            <div style="text-align: center; margin-top: 20px;">
                <a href="auth.html" class="btn">ğŸ”‘ ç«‹å³ç™»å½•</a>
            </div>
        </div>

        <!-- åŠŸèƒ½è¯´æ˜ -->
        <div class="card float-hover" id="featureDesc">
            <h2 class="card-title">ğŸ¯ é—®é“åŠŸèƒ½</h2>
            <p style="text-align: center; color: var(--text-secondary);">
                å¤©ä¹™è´µäººï¼Œä¸¥è‚ƒä¸“ä¸šçš„å…«å­—å¤§å¸ˆ<br>
                ä»¥"è´«é“"è‡ªç§°ï¼Œä¸ºä½ è§£ç­”äº‹ä¸šã€å§»ç¼˜ã€æ—¶è¿ä¹‹æƒ‘
            </p>
        </div>

        <!-- è¾“å…¥è¡¨å• -->
        <div class="card float-hover" id="formContainer">
            <h2 class="card-title">ğŸ“ è¾“å…¥ç”Ÿè¾°ä¿¡æ¯</h2>
            
            <form id="wendaoForm">
                <!-- å‡ºç”Ÿæ—¥æœŸ -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">å‡ºç”Ÿå¹´ä»½</label>
                        <input type="number" class="form-input" id="year" value="2000" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å‡ºç”Ÿæœˆä»½</label>
                        <input type="number" class="form-input" id="month" min="1" max="12" value="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å‡ºç”Ÿæ—¥æœŸ</label>
                        <input type="number" class="form-input" id="day" min="1" max="31" value="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å‡ºç”Ÿæ—¶è¾°</label>
                        <select class="form-select" id="hour" required>
                            <option value="0">å­æ—¶ (23:00-01:00)</option>
                            <option value="2">ä¸‘æ—¶ (01:00-03:00)</option>
                            <option value="4">å¯…æ—¶ (03:00-05:00)</option>
                            <option value="6">å¯æ—¶ (05:00-07:00)</option>
                            <option value="8">è¾°æ—¶ (07:00-09:00)</option>
                            <option value="10">å·³æ—¶ (09:00-11:00)</option>
                            <option value="12" selected>åˆæ—¶ (11:00-13:00)</option>
                            <option value="14">æœªæ—¶ (13:00-15:00)</option>
                            <option value="16">ç”³æ—¶ (15:00-17:00)</option>
                            <option value="18">é…‰æ—¶ (17:00-19:00)</option>
                            <option value="20">æˆŒæ—¶ (19:00-21:00)</option>
                            <option value="22">äº¥æ—¶ (21:00-23:00)</option>
                        </select>
                    </div>
                </div>

                <!-- å…«å­—é¢„è§ˆ -->
                <div id="baziPreview" style="display: none;">
                    <h3 style="text-align: center; color: var(--accent-color); margin: 20px 0;">å…«å­—é¢„è§ˆ</h3>
                    <div class="bazi-display" id="baziDisplay">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- é—®é¢˜ç±»å‹ -->
                <div class="form-group">
                    <label class="form-label">å’¨è¯¢æ–¹å‘</label>
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary question-type" data-type="career">ğŸ¢ äº‹ä¸š</button>
                        <button type="button" class="btn btn-secondary question-type" data-type="marriage">ğŸ’• å§»ç¼˜</button>
                        <button type="button" class="btn btn-secondary question-type" data-type="fortune">â° æ—¶è¿</button>
                    </div>
                    <input type="hidden" id="questionType" value="career">
                </div>

                <!-- å…·ä½“é—®é¢˜ -->
                <div class="form-group">
                    <label class="form-label">
                        å…·ä½“é—®é¢˜
                        <span id="currentTypeTag" class="type-tag" style="
                            display: inline-block;
                            margin-left: 10px;
                            padding: 2px 10px;
                            border-radius: 12px;
                            font-size: 12px;
                            font-weight: 600;
                            background: linear-gradient(135deg, var(--accent-color), var(--accent-secondary));
                            color: var(--primary-bg);
                            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.3);
                            transition: all 0.3s ease;
                        ">äº‹ä¸š</span>
                    </label>
                    <textarea class="form-textarea" id="userQuestion" placeholder="è¯·è¾“å…¥ä½ æƒ³é—®çš„å…·ä½“é—®é¢˜ï¼Œå¦‚ï¼šæˆ‘æœ€è¿‘æ‰¾å·¥ä½œé¡ºåˆ©å—ï¼Ÿ"></textarea>
                </div>

                <!-- æäº¤æŒ‰é’® -->
                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn" id="submitBtn">
                        <span id="btnText">ğŸ™ è¯·å¤©ä¹™è´µäººæŒ‡ç‚¹</span>
                    </button>
                </div>
            </form>

            <!-- åŠ è½½åŠ¨ç”» -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p class="loading-text">å¤©ä¹™è´µäººæ­£åœ¨æ¨ç®—...</p>
            </div>

            <!-- ç»“æœå±•ç¤º -->
            <div class="result-container" id="resultContainer">
                <h3 class="result-title">ğŸ“œ å¤©ä¹™è´µäººè°•ç¤º</h3>
                <div class="result-content" id="resultContent"></div>
                <div class="audio-controls" id="audioControls" style="display: none;">
                    <button class="audio-btn" id="playTTSBtn">ğŸ”Š æœ—è¯»ç»“æœ</button>
                </div>
            </div>
        </div>

        <!-- å†å²è®°å½• -->
        <div class="card" id="historyCard" style="display: none;">
            <h2 class="card-title">ğŸ“š å†å²è®°å½•</h2>
            <div class="history-list" id="historyList">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- é¡µè„š -->
        <footer class="footer">
            <p>é—®æ¸  - æ™ºèƒ½å…«å­—å åœå¹³å°</p>
            <p>å¤©ä¹™è´µäººä¸ºä½ æŒ‡ç‚¹è¿·æ´¥</p>
        </footer>
    </div>

    <script src="app.js"></script>
    <script src="analytics.js"></script>
    <script src="enhanced-animations.js"></script>
    <script>
        // åˆå§‹åŒ–æ•°æ®åˆ†æ
        if (window.Analytics) {
            // å…ˆè®¾ç½®ç”¨æˆ·é‚®ç®±ï¼ˆåœ¨ init ä¹‹å‰ï¼‰
            const user = JSON.parse(localStorage.getItem('wq_user') || '{}');
            console.log('[Wendao] User from localStorage:', user);
            if (user.email) {
                console.log('[Wendao] Setting email before init:', user.email);
                window.__wq_user_email = user.email;
            }
            
            Analytics.init();
            
            if (user.email) {
                console.log('[Wendao] Identifying user:', user.email);
                Analytics.identify(user.email);
            } else {
                console.log('[Wendao] No email found in user data');
            }
        }
    </script>
    <script>
        // é—®é“é¡µé¢ä¸“ç”¨é€»è¾‘
        (function() {
            // é—®é¢˜ç±»å‹é€‰æ‹©
            document.querySelectorAll('.question-type').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.question-type').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const type = this.dataset.type;
                    document.getElementById('questionType').value = type;
                    
                    // æ›´æ–°ç±»å‹æ ‡ç­¾
                    const typeTag = document.getElementById('currentTypeTag');
                    const input = document.getElementById('userQuestion');
                    
                    if (type === 'career') {
                        typeTag.textContent = 'äº‹ä¸š';
                        typeTag.style.background = 'linear-gradient(135deg, #4a90e2, #357abd)';
                        typeTag.style.boxShadow = '0 2px 8px rgba(74, 144, 226, 0.3)';
                        input.placeholder = 'è¯·è¾“å…¥ä½ æƒ³é—®çš„äº‹ä¸šé—®é¢˜ï¼Œå¦‚ï¼šæˆ‘æœ€è¿‘æ‰¾å·¥ä½œé¡ºåˆ©å—ï¼Ÿ';
                    } else if (type === 'marriage') {
                        typeTag.textContent = 'å©šå§»';
                        typeTag.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
                        typeTag.style.boxShadow = '0 2px 8px rgba(231, 76, 60, 0.3)';
                        input.placeholder = 'è¯·è¾“å…¥ä½ æƒ³é—®çš„æ„Ÿæƒ…é—®é¢˜ï¼Œå¦‚ï¼šæˆ‘çš„æ­£ç¼˜ä»€ä¹ˆæ—¶å€™å‡ºç°ï¼Ÿ';
                    } else {
                        typeTag.textContent = 'æ—¶è¿';
                        typeTag.style.background = 'linear-gradient(135deg, #27ae60, #1e8449)';
                        typeTag.style.boxShadow = '0 2px 8px rgba(39, 174, 96, 0.3)';
                        input.placeholder = 'è¯·è¾“å…¥ä½ æƒ³é—®çš„è¿åŠ¿é—®é¢˜ï¼Œå¦‚ï¼šä»Šå¹´æˆ‘çš„è´¢è¿å¦‚ä½•ï¼Ÿ';
                    }
                });
            });

            // é»˜è®¤é€‰ä¸­äº‹ä¸š
            document.querySelector('.question-type[data-type="career"]').click();

            // è¡¨å•æäº¤
            document.getElementById('wendaoForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // è¿½è¸ªè½¬åŒ–æ¼æ–— - æäº¤è¡¨å•
                if (window.Analytics) {
                    Analytics.trackFunnel('wendao_consultation', 'submit_form', 1);
                }
                
                const year = parseInt(document.getElementById('year').value);
                const month = parseInt(document.getElementById('month').value);
                const day = parseInt(document.getElementById('day').value);
                const hour = parseInt(document.getElementById('hour').value);
                const questionType = document.getElementById('questionType').value;
                const userQuestion = document.getElementById('userQuestion').value;

                // æ˜¾ç¤ºåŠ è½½
                document.getElementById('loading').classList.add('show');
                document.getElementById('resultContainer').classList.remove('show');
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('btnText').textContent = 'æ¨ç®—ä¸­...';

                try {
                    // è¿½è¸ªè¡¨å•æäº¤
                    if (window.WenQuAnalytics) {
                        WenQuAnalytics.formSubmit('wendao', true, { questionType });
                    }
                    
                    // å…ˆè®¡ç®—å…«å­—
                    const baziRes = await fetch('/api/calculate_bazi', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ year, month, day, hour })
                    });
                    const baziData = await baziRes.json();

                    if (baziData.success) {
                        // æ˜¾ç¤ºå…«å­—é¢„è§ˆ
                        displayBazi(baziData.baziData);
                        
                        // è¿½è¸ªåŠŸèƒ½ä½¿ç”¨ - å¼€å§‹æµ‹ç®—
                        if (window.Analytics) {
                            Analytics.trackFeature('wendao', 'start', {
                                question_type: questionType,
                                has_question: !!userQuestion
                            });
                        }
                        
                        // è°ƒç”¨AIåˆ†æ
                        const endpoint = questionType === 'marriage' ? '/api/ask_marriage' : 
                                         questionType === 'fortune' ? '/api/ask_fortune' : '/api/ask';
                        
                        // è¿½è¸ªAIè¯·æ±‚å¼€å§‹
                        const aiStartTime = Date.now();
                        if (window.WenQuAnalytics) {
                            WenQuAnalytics.trackAIRequest(questionType, userQuestion.length);
                        }

                        const res = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ year, month, day, hour, question: userQuestion })
                        });
                        const data = await res.json();
                        
                        // è¿½è¸ªAIå“åº”å®Œæˆ
                        if (window.WenQuAnalytics) {
                            WenQuAnalytics.trackAIResponse(aiStartTime, data.success);
                        }

                        if (data.success) {
                            displayResult(data);
                            saveToHistory(data);
                            
                            // è¿½è¸ªåŠŸèƒ½ä½¿ç”¨ - å®Œæˆæµ‹ç®—
                            if (window.Analytics) {
                                Analytics.trackFeature('wendao', 'complete', {
                                    question_type: questionType,
                                    duration_ms: Date.now() - aiStartTime
                                });
                            }
                            
                            // è¿½è¸ªè½¬åŒ–æ¼æ–— - æŸ¥çœ‹ç»“æœ
                            if (window.Analytics) {
                                Analytics.trackFunnel('wendao_consultation', 'view_result', 2, {
                                    question_type: questionType
                                });
                            }
                        } else {
                            alert('åˆ†æå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                        }
                    } else {
                        alert('å…«å­—è®¡ç®—å¤±è´¥');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    
                    // è¿½è¸ªé”™è¯¯
                    if (window.WenQuAnalytics) {
                        WenQuAnalytics.trackAIError('request_failed', error.message);
                    }
                    
                    let errorMsg = 'è¯·æ±‚å¤±è´¥';
                    
                    if (error.message && error.message.includes('Failed to fetch')) {
                        errorMsg = 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼\n\nè¯·æ£€æŸ¥ï¼š\n1. æ˜¯å¦è¿è¡Œäº† npm start å¯åŠ¨æœåŠ¡å™¨\n2. è®¿é—®åœ°å€æ˜¯å¦ä¸º http://localhost:3000\n3. ç«¯å£3000æ˜¯å¦è¢«å ç”¨';
                    } else if (error.message) {
                        errorMsg = 'è¯·æ±‚å¤±è´¥ï¼š' + error.message;
                    }
                    
                    alert(errorMsg);
                } finally {
                    document.getElementById('loading').classList.remove('show');
                    document.getElementById('submitBtn').disabled = false;
                    document.getElementById('btnText').textContent = 'ğŸ™ è¯·å¤©ä¹™è´µäººæŒ‡ç‚¹';
                }
            });

            // æ˜¾ç¤ºå…«å­—
            function displayBazi(baziData) {
                const display = document.getElementById('baziDisplay');
                const bazi = baziData.bazi;
                display.innerHTML = `
                    <div class="bazi-pillar bazi-pillar-animated">
                        <div class="pillar-label">å¹´æŸ±</div>
                        <div class="pillar-content glow-text">${bazi.yearPillar}</div>
                    </div>
                    <div class="bazi-pillar bazi-pillar-animated">
                        <div class="pillar-label">æœˆæŸ±</div>
                        <div class="pillar-content glow-text">${bazi.monthPillar}</div>
                    </div>
                    <div class="bazi-pillar bazi-pillar-animated">
                        <div class="pillar-label">æ—¥æŸ±</div>
                        <div class="pillar-content glow-text">${bazi.dayPillar}</div>
                    </div>
                    <div class="bazi-pillar bazi-pillar-animated">
                        <div class="pillar-label">æ—¶æŸ±</div>
                        <div class="pillar-content glow-text">${bazi.hourPillar}</div>
                    </div>
                `;
                document.getElementById('baziPreview').style.display = 'block';
            }

            // æ˜¾ç¤ºç»“æœï¼ˆå¸¦æ‰“å­—æœºæ•ˆæœï¼‰
            async function displayResult(data) {
                const container = document.getElementById('resultContainer');
                const content = document.getElementById('resultContent');
                const audioControls = document.getElementById('audioControls');

                container.classList.add('show');
                audioControls.style.display = 'none';
                
                const text = data.analysis || data.result || 'æš‚æ— åˆ†æç»“æœ';
                
                // ä½¿ç”¨æ‰“å­—æœºæ•ˆæœ
                if (window.EnhancedAnimations && window.EnhancedAnimations.Typewriter) {
                    await window.EnhancedAnimations.Typewriter.type(content, text, 20);
                } else {
                    content.textContent = text;
                }
                
                audioControls.style.display = 'flex';
            }

            // æœ—è¯»ç»“æœï¼ˆä½¿ç”¨æµè§ˆå™¨åŸç”ŸTTSï¼‰
            document.getElementById('playTTSBtn')?.addEventListener('click', function() {
                const content = document.getElementById('resultContent').textContent;
                if (content && window.WenQu && window.WenQu.TTS) {
                    window.WenQu.TTS.speak(content);
                }
            });

            // ä¿å­˜å†å²è®°å½•
            function saveToHistory(data) {
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
                if (!window.WenQu || !window.WenQu.Auth || !window.WenQu.Auth.isLoggedIn()) {
                    // æœªç™»å½•ç”¨æˆ·ä¸ä¿å­˜å†å²è®°å½•
                    return;
                }
                
                const userId = window.WenQu.Auth.getUserId();
                const historyKey = `wendaoHistory_${userId}`;
                
                // è·å–ç”¨æˆ·é—®é¢˜
                const questionType = document.getElementById('questionType').value;
                const userQuestion = document.getElementById('userQuestion').value;
                const typeNames = {
                    'career': 'äº‹ä¸š',
                    'marriage': 'å§»ç¼˜',
                    'fortune': 'æ—¶è¿'
                };
                
                let history = JSON.parse(localStorage.getItem(historyKey) || '[]');
                history.unshift({
                    time: new Date().toLocaleString(),
                    type: typeNames[questionType] || 'å…«å­—',
                    question: userQuestion || 'å…«å­—åˆ†æ',
                    content: data.analysis?.substring(0, 50) + '...' || 'å…«å­—åˆ†æ',
                    fullData: data
                });
                if (history.length > 10) history = history.slice(0, 10);
                localStorage.setItem(historyKey, JSON.stringify(history));
                loadHistory();
            }

            // åŠ è½½å†å²è®°å½•
            function loadHistory() {
                const list = document.getElementById('historyList');
                const card = document.getElementById('historyCard');
                
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
                if (!window.WenQu || !window.WenQu.Auth || !window.WenQu.Auth.isLoggedIn()) {
                    // æœªç™»å½•ç”¨æˆ·ä¸æ˜¾ç¤ºå†å²è®°å½•
                    card.style.display = 'none';
                    return;
                }
                
                const userId = window.WenQu.Auth.getUserId();
                const historyKey = `wendaoHistory_${userId}`;
                const history = JSON.parse(localStorage.getItem(historyKey) || '[]');

                if (history.length === 0) {
                    card.style.display = 'none';
                    return;
                }

                card.style.display = 'block';
                list.innerHTML = history.map((item, index) => `
                    <div class="history-item" data-index="${index}">
                        <div class="history-time">${item.time}</div>
                        <div class="history-question">
                            <span class="history-type">[${item.type || 'å…«å­—'}]</span>
                            ${item.question || 'å…«å­—åˆ†æ'}
                        </div>
                    </div>
                `).join('');

                // ç‚¹å‡»å†å²è®°å½•åŠ è½½
                list.querySelectorAll('.history-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const idx = parseInt(this.dataset.index);
                        const data = history[idx].fullData;
                        displayResult(data);
                    });
                });
            }

            // é¡µé¢åŠ è½½æ—¶åŠ è½½å†å²
            loadHistory();
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            checkLoginStatus();
        })();
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            const user = JSON.parse(localStorage.getItem('wq_user') || '{}');
            const loginRequired = document.getElementById('loginRequired');
            const formContainer = document.getElementById('formContainer');
            const featureDesc = document.getElementById('featureDesc');
            const authLink = document.getElementById('authLink');
            const dataLink = document.getElementById('dataLink');
            const adminLink = document.getElementById('adminLink');
            const homeLink = document.getElementById('homeLink');
            const wendaoLink = document.getElementById('wendaoLink');
            const liuyaoLink = document.getElementById('liuyaoLink');
            const hebanLink = document.getElementById('hebanLink');
            
            // æ”¯æŒæ¸¸å®¢æ¨¡å¼ - æœ‰ç”¨æˆ·IDï¼ˆåŒ…æ‹¬æ¸¸å®¢ï¼‰å³å¯ä½¿ç”¨
            if (!user.id) {
                // å®Œå…¨æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•æç¤º
                loginRequired.style.display = 'block';
                formContainer.style.display = 'none';
                featureDesc.style.display = 'none';
            } else {
                // å·²ç™»å½•ï¼ˆæ™®é€šç”¨æˆ·æˆ–æ¸¸å®¢ï¼‰ï¼Œæ˜¾ç¤ºè¡¨å•
                loginRequired.style.display = 'none';
                formContainer.style.display = 'block';
                featureDesc.style.display = 'block';
                
                // ç®¡ç†å‘˜æ˜¾ç¤ºæ•°æ®å’Œç®¡ç†æŒ‰é’®ï¼Œå¹¶éšè—ä¸šåŠ¡åŠŸèƒ½æŒ‰é’®
                if (user.role === 'admin') {
                    if (dataLink) dataLink.style.display = 'inline-block';
                    if (adminLink) adminLink.style.display = 'inline-block';
                    // éšè—é¦–é¡µã€é—®é“ã€å…­çˆ»ã€åˆç›˜æŒ‰é’®
                    if (homeLink) homeLink.style.display = 'none';
                    if (wendaoLink) wendaoLink.style.display = 'none';
                    if (liuyaoLink) liuyaoLink.style.display = 'none';
                    if (hebanLink) hebanLink.style.display = 'none';
                    authLink.style.display = 'none'; // éšè—ç™»å½•/é€€å‡ºæŒ‰é’®
                } else {
                    // æ™®é€šç”¨æˆ·æˆ–æ¸¸å®¢ï¼Œæ›´æ–°å¯¼èˆªä¸ºé€€å‡º
                    authLink.textContent = 'ğŸšª é€€å‡º';
                    authLink.href = '#';
                    authLink.onclick = function(e) {
                        e.preventDefault();
                        const isGuest = user.isGuest;
                        const confirmMsg = isGuest ? 'é€€å‡ºåå°†æ¸…é™¤å½“å‰ä¼šè¯ï¼Œç¡®å®šè¦é€€å‡ºå—ï¼Ÿ' : 'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ';
                        if (confirm(confirmMsg)) {
                            localStorage.removeItem('wq_user');
                            window.location.href = 'main.html';
                        }
                    };
                }
            }
        }
    </script>
</body>
</html>