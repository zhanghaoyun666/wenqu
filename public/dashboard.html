<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®çœ‹æ¿ - é—®æ¸ </title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="enhanced-animations.css">
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(212, 175, 55, 0.05));
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.2);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--accent-color);
            margin: 10px 0;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }
        
        .chart-container {
            background: rgba(30, 30, 50, 0.5);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .chart-title {
            font-size: 1.2rem;
            color: var(--accent-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .data-table th {
            color: var(--accent-color);
            font-weight: 500;
        }
        
        .data-table tr:hover {
            background: rgba(212, 175, 55, 0.05);
        }
        
        .period-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        
        .period-btn {
            padding: 8px 20px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .period-btn:hover,
        .period-btn.active {
            background: var(--accent-color);
            color: #1a1a2e;
            border-color: var(--accent-color);
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: var(--text-secondary);
        }
        
        .error-message {
            text-align: center;
            padding: 50px;
            color: #ff6464;
        }
        
        .feature-bar {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .feature-name {
            width: 120px;
            color: var(--text-secondary);
        }
        
        .feature-progress {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 0 15px;
        }
        
        .feature-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), #f0c674);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .feature-count {
            width: 60px;
            text-align: right;
            color: var(--accent-color);
            font-weight: 500;
        }
    </style>
</head>
<body>
    <script>
        // æ–°ä¼šè¯æ£€æµ‹ - åˆ·æ–°æˆ–é‡æ–°æ‰“å¼€ç½‘ç«™æ—¶æ¸…é™¤ç™»å½•çŠ¶æ€å¹¶è¿”å›ä¸»ç•Œé¢
        (function() {
            const isNewSession = !sessionStorage.getItem('wq_session_active');
            const isFromOtherPage = document.referrer && document.referrer.includes(window.location.hostname);
            
            console.log('[Dashboard] Session check:', { isNewSession, isFromOtherPage, referrer: document.referrer });
            
            if (isNewSession) {
                sessionStorage.setItem('wq_session_active', 'true');
                if (!isFromOtherPage) {
                    console.log('[Dashboard] Clearing auth and redirecting to main');
                    localStorage.removeItem('wq_user');
                    localStorage.removeItem('wq_token');
                    window.location.href = 'main.html';
                    return;
                }
            }
        })();
        
        // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
        (function() {
            const user = JSON.parse(localStorage.getItem('wq_user') || '{}');
            if (!user.id || user.role !== 'admin') {
                alert('æ— æƒè®¿é—®æ•°æ®çœ‹æ¿');
                window.location.href = 'main.html';
            }
        })();
    </script>
    <div class="bg-decoration"></div>
    
    <div class="container dashboard-container">
        <!-- å¤´éƒ¨ -->
        <header class="header">
            <h1 class="logo glow-text">é—®æ¸ </h1>
            <p class="subtitle">ğŸ“Š æ•°æ®åˆ†æçœ‹æ¿</p>
        </header>

        <!-- å¯¼èˆª -->
        <nav class="nav" id="adminNav">
            <a href="dashboard.html" class="nav-btn active">ğŸ“Š æ•°æ®</a>
            <a href="admin.html" class="nav-btn">âš™ï¸ ç®¡ç†</a>
            <a href="#" class="nav-btn" onclick="logout()">ğŸšª é€€å‡º</a>
        </nav>

        <!-- æ—¶é—´é€‰æ‹©å™¨ -->
        <div class="period-selector">
            <button class="period-btn active" data-days="7">è¿‘7å¤©</button>
            <button class="period-btn" data-days="30">è¿‘30å¤©</button>
            <button class="period-btn" data-days="90">è¿‘90å¤©</button>
        </div>

        <!-- æ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡ -->
        <div class="stats-grid" id="statsCards">

            <div class="stat-card">
                <div class="stat-label">åŠŸèƒ½ä½¿ç”¨æ¬¡æ•°</div>
                <div class="stat-value" id="totalFeatures">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">API è°ƒç”¨æ¬¡æ•°</div>
                <div class="stat-value" id="totalApiCalls">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">é¡µé¢è®¿é—®é‡</div>
                <div class="stat-value" id="totalPageViews">-</div>
            </div>
        </div>

        <!-- åŠŸèƒ½ä½¿ç”¨ç»Ÿè®¡ -->
        <div class="chart-container">
            <h3 class="chart-title">ğŸ”® åŠŸèƒ½ä½¿ç”¨æƒ…å†µ</h3>
            <div id="featureStats">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- API æ€§èƒ½ç»Ÿè®¡ -->
        <div class="chart-container">
            <h3 class="chart-title">âš¡ API æ€§èƒ½</h3>
            <div id="apiStats">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- çƒ­é—¨é¡µé¢ -->
        <div class="chart-container">
            <h3 class="chart-title">ğŸ“„ çƒ­é—¨é¡µé¢</h3>
            <div id="pageStats">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- é¡µè„š -->
        <footer class="footer">
            <p>é—®æ¸  - æ™ºèƒ½å…«å­—å åœå¹³å°</p>
        </footer>
    </div>

    <script src="analytics.js"></script>
    <script>
        // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
        (function() {
            const user = JSON.parse(localStorage.getItem('wq_user') || '{}');
            if (!user.id || user.role !== 'admin') {
                alert('æ— æƒè®¿é—®æ•°æ®çœ‹æ¿ï¼Œä»…é™ç®¡ç†å‘˜');
                window.location.href = 'main.html';
                return;
            }
            
            // ç®¡ç†å‘˜å·²éªŒè¯ï¼Œæ— éœ€é¢å¤–æ“ä½œ
        })();

        let currentPeriod = 7;

        // æ—¶é—´é€‰æ‹©å™¨
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentPeriod = parseInt(this.dataset.days);
                loadStats();
            });
        });

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                const response = await fetch(`/api/analytics/stats?days=${currentPeriod}`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'åŠ è½½å¤±è´¥');
                }

                const stats = data.stats;

                // æ›´æ–°æ ¸å¿ƒæŒ‡æ ‡

                document.getElementById('totalFeatures').textContent = stats.summary.totalFeatureUsage.toLocaleString();
                document.getElementById('totalApiCalls').textContent = stats.summary.totalApiCalls.toLocaleString();
                document.getElementById('totalPageViews').textContent = stats.summary.totalPageViews.toLocaleString();

                // æ¸²æŸ“åŠŸèƒ½ä½¿ç”¨ç»Ÿè®¡
                renderFeatureStats(stats.featureBreakdown);

                // æ¸²æŸ“ API æ€§èƒ½ç»Ÿè®¡
                renderApiStats(stats.apiPerformance);

                // æ¸²æŸ“é¡µé¢è®¿é—®ç»Ÿè®¡
                renderPageStats(stats.topPages);

            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                document.getElementById('statsCards').innerHTML = `
                    <div class="error-message" style="grid-column: 1 / -1;">
                        åŠ è½½å¤±è´¥: ${error.message}<br>
                        è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•
                    </div>
                `;
            }
        }

        // æ¸²æŸ“åŠŸèƒ½ä½¿ç”¨ç»Ÿè®¡
        function renderFeatureStats(featureBreakdown) {
            const container = document.getElementById('featureStats');
            
            if (!featureBreakdown || Object.keys(featureBreakdown).length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— æ•°æ®</div>';
                return;
            }

            const maxCount = Math.max(...Object.values(featureBreakdown));
            
            const featureNames = {
                'bazi_start': 'å…«å­—-å¼€å§‹',
                'bazi_complete': 'å…«å­—-å®Œæˆ',
                'liuyao_start': 'å…­çˆ»-å¼€å§‹',
                'liuyao_complete': 'å…­çˆ»-å®Œæˆ',
                'heban_start': 'åˆç›˜-å¼€å§‹',
                'heban_complete': 'åˆç›˜-å®Œæˆ',
                'wendao_start': 'é—®é“-å¼€å§‹',
                'wendao_complete': 'é—®é“-å®Œæˆ',
                'hunyin_start': 'å©šå§»-å¼€å§‹',
                'hunyin_complete': 'å©šå§»-å®Œæˆ',
                'shiyun_start': 'æ—¶è¿-å¼€å§‹',
                'shiyun_complete': 'æ—¶è¿-å®Œæˆ'
            };

            let html = '';
            for (const [key, count] of Object.entries(featureBreakdown).sort((a, b) => b[1] - a[1])) {
                const percentage = (count / maxCount) * 100;
                const name = featureNames[key] || key;
                html += `
                    <div class="feature-bar">
                        <div class="feature-name">${name}</div>
                        <div class="feature-progress">
                            <div class="feature-progress-bar" style="width: ${percentage}%"></div>
                        </div>
                        <div class="feature-count">${count}</div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        // æ¸²æŸ“ API æ€§èƒ½ç»Ÿè®¡
        function renderApiStats(apiPerformance) {
            const container = document.getElementById('apiStats');
            
            if (!apiPerformance || apiPerformance.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— æ•°æ®</div>';
                return;
            }

            const endpointNames = {
                '/api/ask': 'å…«å­—åˆ†æ',
                '/api/ask_marriage': 'å©šå§»åˆ†æ',
                '/api/ask_fortune': 'æ—¶è¿åˆ†æ',
                '/api/ask_liuyao': 'å…­çˆ»æµ‹ç®—',
                '/api/ask_heban': 'åˆç›˜åˆ†æ',
                '/api/calculate_bazi': 'å…«å­—è®¡ç®—',
                '/api/analytics/track': 'æ•°æ®è¿½è¸ª',
                '/api/auth/login': 'ç”¨æˆ·ç™»å½•',
                '/api/auth/register': 'ç”¨æˆ·æ³¨å†Œ',
                '/health': 'å¥åº·æ£€æŸ¥'
            };

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>æ¥å£</th>
                            <th>è°ƒç”¨æ¬¡æ•°</th>
                            <th>é”™è¯¯ç‡</th>
                            <th>å¹³å‡å“åº”æ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const api of apiPerformance.slice(0, 10)) {
                const name = endpointNames[api.endpoint] || api.endpoint;
                html += `
                    <tr>
                        <td>${name}</td>
                        <td>${api.calls}</td>
                        <td>${api.errorRate}</td>
                        <td>${api.avgResponseTime}</td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // æ¸²æŸ“é¡µé¢è®¿é—®ç»Ÿè®¡
        function renderPageStats(topPages) {
            const container = document.getElementById('pageStats');
            
            if (!topPages || topPages.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— æ•°æ®</div>';
                return;
            }

            const pathNames = {
                '/': 'é¦–é¡µ',
                '/main.html': 'é¦–é¡µ',
                '/wendao.html': 'é—®é“',
                '/liuyao.html': 'å…­çˆ»',
                '/heban.html': 'åˆç›˜',
                '/auth.html': 'ç™»å½•/æ³¨å†Œ',
                '/admin.html': 'ç®¡ç†åå°',
                '/dashboard.html': 'æ•°æ®çœ‹æ¿'
            };

            const maxViews = Math.max(...topPages.map(p => p.views));
            
            let html = '';
            for (const page of topPages) {
                const percentage = (page.views / maxViews) * 100;
                const name = pathNames[page.path] || page.path;
                html += `
                    <div class="feature-bar">
                        <div class="feature-name" style="width: 150px;">${name}</div>
                        <div class="feature-progress">
                            <div class="feature-progress-bar" style="width: ${percentage}%"></div>
                        </div>
                        <div class="feature-count">${page.views}</div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
        loadStats();
        
        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                localStorage.removeItem('wq_user');
                localStorage.removeItem('wq_token');
                window.location.href = 'main.html';
            }
        }
    </script>
</body>
</html>