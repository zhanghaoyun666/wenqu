<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…­çˆ» - å¤ªæè´µäºº | é—®æ¸ </title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="enhanced-animations.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="page-transition">
    <script>
        // æ–°ä¼šè¯æ£€æµ‹ - åˆ·æ–°æˆ–é‡æ–°æ‰“å¼€ç½‘ç«™æ—¶æ¸…é™¤ç™»å½•çŠ¶æ€å¹¶è¿”å›ä¸»ç•Œé¢
        (function() {
            const isNewSession = !sessionStorage.getItem('wq_session_active');
            const isFromOtherPage = document.referrer && document.referrer.includes(window.location.hostname);
            
            if (isNewSession) {
                sessionStorage.setItem('wq_session_active', 'true');
                if (!isFromOtherPage) {
                    localStorage.removeItem('wq_user');
                    localStorage.removeItem('wq_token');
                    window.location.href = 'main.html';
                    return;
                }
            }
            
            // ç®¡ç†å‘˜ä¸èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½
            const user = JSON.parse(localStorage.getItem('wq_user') || '{}');
            if (user.role === 'admin') {
                alert('ç®¡ç†å‘˜è´¦å·æ— æ³•ä½¿ç”¨æ­¤åŠŸèƒ½');
                window.location.href = 'admin.html';
            }
        })();
    </script>
    <div class="bg-decoration"></div>
    
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <header class="header">
            <h1 class="logo glow-text">é—®æ¸ </h1>
            <p class="subtitle">å…­çˆ» Â· å¤ªæè´µäºº</p>
        </header>

        <!-- å¯¼èˆª -->
        <nav class="nav">
            <a href="main.html" class="nav-btn" id="homeLink">é¦–é¡µ</a>
            <a href="wendao.html" class="nav-btn" id="wendaoLink">é—®é“</a>
            <a href="liuyao.html" class="nav-btn active" id="liuyaoLink">å…­çˆ»</a>
            <a href="heban.html" class="nav-btn" id="hebanLink">åˆç›˜</a>
            <a href="dashboard.html" class="nav-btn" id="dataLink" style="display: none;">ğŸ“Š æ•°æ®</a>
            <a href="admin.html" class="nav-btn" id="adminLink" style="display: none;">âš™ï¸ ç®¡ç†</a>
            <a href="auth.html" class="nav-btn" id="authLink">ğŸ”‘ ç™»å½•</a>
        </nav>

        <!-- ç™»å½•æ£€æŸ¥æç¤º -->
        <div id="loginRequired" class="card" style="border-color: rgba(255, 100, 100, 0.5); display: none;">
            <h2 class="card-title" style="color: #ff6464;">ğŸ”’ è¯·å…ˆç™»å½•</h2>
            <p style="text-align: center; color: var(--text-secondary); line-height: 2;">
                ä½¿ç”¨å…­çˆ»å åœåŠŸèƒ½éœ€è¦å…ˆç™»å½•è´¦å·<br>
                ç™»å½•åå¯ä»¥ä¿å­˜å¦è±¡è®°å½•ï¼Œéšæ—¶æŸ¥çœ‹è¿‡å¾€å åœ
            </p>
            <div style="text-align: center; margin-top: 20px;">
                <a href="auth.html" class="btn">ğŸ”‘ ç«‹å³ç™»å½•</a>
            </div>
        </div>

        <!-- åŠŸèƒ½è¯´æ˜ -->
        <div class="card float-hover" id="featureDesc">
            <h2 class="card-title">â˜¯ å…­çˆ»å åœ</h2>
            <p style="text-align: center; color: var(--text-secondary);">
                å¤ªæè´µäººï¼Œä»™é£é“éª¨çš„å åœä¸“å®¶<br>
                ä¸‰æšé“œé’±ï¼Œå…­æ¬¡æŠ•æ·ï¼Œå¦è±¡å¤©æˆ<br>
                é’ˆå¯¹å…·ä½“äº‹ä»¶ï¼Œç»™å‡ºæ˜ç¡®å‰å‡¶æŒ‡å¼•
            </p>
        </div>

        <!-- å åœåŒºåŸŸ -->
        <div class="card float-hover" id="divinationArea">
            <h2 class="card-title">ğŸ² å¼€å§‹å åœ</h2>
            
            <!-- é—®é¢˜è¾“å…¥ -->
            <div class="form-group">
                <label class="form-label">å¿ƒä¸­é»˜å¿µä½ æƒ³é—®çš„é—®é¢˜</label>
                <textarea class="form-textarea" id="userQuestion" placeholder="è¯·è¾“å…¥å…·ä½“é—®é¢˜ï¼Œå¦‚ï¼šæˆ‘èƒ½æ‹¿åˆ°é¡¹ç›®è·¯æ¼”ä¸€ç­‰å¥–å—ï¼Ÿï¼ˆé—®é¢˜è¶Šå…·ä½“ï¼Œå¦è±¡è¶Šå‡†ï¼‰"></textarea>
            </div>

            <!-- é“œé’±æ‘‡å¦åŒºåŸŸ -->
            <div id="coinArea" style="text-align: center; margin: 40px 0;">
                <div class="coin-container">
                    <div class="coin" id="coin1">
                        <div class="coin-face coin-front">é˜³</div>
                        <div class="coin-face coin-back">é˜´</div>
                    </div>
                    <div class="coin" id="coin2">
                        <div class="coin-face coin-front">é˜³</div>
                        <div class="coin-face coin-back">é˜´</div>
                    </div>
                    <div class="coin" id="coin3">
                        <div class="coin-face coin-front">é˜³</div>
                        <div class="coin-face coin-back">é˜´</div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <p id="tossInfo" style="color: var(--accent-color); font-size: 1.2rem; margin-bottom: 20px;">
                        å‡†å¤‡å°±ç»ªï¼Œè¯·ç‚¹å‡»å¼€å§‹æ‘‡å¦
                    </p>
                    <button class="btn" id="tossBtn">ğŸ² å¼€å§‹æ‘‡å¦</button>
                </div>
            </div>

            <!-- æŠ•æ·è¿›åº¦ -->
            <div id="progressArea" style="display: none; text-align: center; margin: 20px 0;">
                <p style="color: var(--secondary-color);">å·²å®Œæˆ <span id="currentToss">0</span> / 6 æ¬¡æŠ•æ·</p>
                <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px; flex-wrap: wrap;" id="tossResults">
                    <!-- åŠ¨æ€ç”ŸæˆæŠ•æ·ç»“æœ -->
                </div>
            </div>

            <!-- å¦è±¡å±•ç¤º -->
            <div id="guaArea" style="display: none;">
                <div class="gua-container">
                    <div class="gua-display">
                        <h3 class="gua-title">æœ¬å¦</h3>
                        <div id="mainGua"></div>
                    </div>
                    <div class="gua-display">
                        <h3 class="gua-title">å˜å¦</h3>
                        <div id="changeGua"></div>
                    </div>
                </div>
            </div>



            <!-- æäº¤æŒ‰é’® -->
            <div style="text-align: center; margin-top: 30px;" id="submitArea" style="display: none;">
                <button class="btn" id="submitBtn">ğŸ™ è¯·å¤ªæè´µäººè§£å¦</button>
            </div>

            <!-- åŠ è½½åŠ¨ç”» -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p class="loading-text">å¤ªæè´µäººæ­£åœ¨è§£å¦...</p>
            </div>

            <!-- ç»“æœå±•ç¤º -->
            <div class="result-container" id="resultContainer">
                <h3 class="result-title">ğŸ“œ å¤ªæè´µäººè§£å¦</h3>
                <div class="result-content" id="resultContent"></div>
                <div class="audio-controls" id="audioControls" style="display: none;">
                    <button class="audio-btn" id="playTTSBtn">ğŸ”Š æœ—è¯»ç»“æœ</button>
                </div>
            </div>
        </div>

        <!-- å…­çˆ»è¯´æ˜ -->
        <div class="card float-hover">
            <h2 class="card-title">ğŸ“– å…­çˆ»è¯´æ˜</h2>
            <div class="tip-box">
                <p><strong>å°‘é˜³ï¼š</strong>ä¸¤æ­£ä¸€åï¼Œè®°ä½œ âšŠï¼Œä¸ºé˜³çˆ»ï¼Œä¸å˜</p>
            </div>
            <div class="tip-box">
                <p><strong>å°‘é˜´ï¼š</strong>ä¸¤åä¸€æ­£ï¼Œè®°ä½œ âš‹ï¼Œä¸ºé˜´çˆ»ï¼Œä¸å˜</p>
            </div>
            <div class="tip-box">
                <p><strong>è€é˜³ï¼š</strong>ä¸‰æ­£ï¼Œè®°ä½œ âšŠï¼Œä¸ºé˜³çˆ»ï¼Œä¼šå˜é˜´ï¼ˆåŠ¨çˆ»ï¼‰</p>
            </div>
            <div class="tip-box">
                <p><strong>è€é˜´ï¼š</strong>ä¸‰åï¼Œè®°ä½œ âš‹ï¼Œä¸ºé˜´çˆ»ï¼Œä¼šå˜é˜³ï¼ˆåŠ¨çˆ»ï¼‰</p>
            </div>
        </div>

        <!-- é¡µè„š -->
        <footer class="footer">
            <p>é—®æ¸  - æ™ºèƒ½å…«å­—å åœå¹³å°</p>
            <p>å¤ªæè´µäººä¸ºä½ å åœå‰å‡¶</p>
        </footer>
    </div>

    <script src="app.js"></script>
    <script src="analytics.js"></script>
    <script src="enhanced-animations.js"></script>
    <script src="liuyao-app.js"></script>
    <script>
        // åˆå§‹åŒ–æ•°æ®åˆ†æ
        if (window.Analytics) {
            // å…ˆè®¾ç½®ç”¨æˆ·é‚®ç®±ï¼ˆåœ¨ init ä¹‹å‰ï¼‰
            const user = JSON.parse(localStorage.getItem('wq_user') || '{}');
            console.log('[Liuyao] User from localStorage:', user);
            if (user.email) {
                console.log('[Liuyao] Setting email before init:', user.email);
                window.__wq_user_email = user.email;
            }
            
            Analytics.init();
            
            if (user.email) {
                console.log('[Liuyao] Identifying user:', user.email);
                Analytics.identify(user.email);
            } else {
                console.log('[Liuyao] No email found in user data');
            }
        }
    </script>
    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        (function() {
            const user = JSON.parse(localStorage.getItem('wq_user') || '{}');
            const loginRequired = document.getElementById('loginRequired');
            const divinationArea = document.getElementById('divinationArea');
            const featureDesc = document.getElementById('featureDesc');
            const authLink = document.getElementById('authLink');
            const dataLink = document.getElementById('dataLink');
            const adminLink = document.getElementById('adminLink');
            const homeLink = document.getElementById('homeLink');
            const wendaoLink = document.getElementById('wendaoLink');
            const liuyaoLink = document.getElementById('liuyaoLink');
            const hebanLink = document.getElementById('hebanLink');
            
            // æ”¯æŒæ¸¸å®¢æ¨¡å¼ - æœ‰ç”¨æˆ·IDï¼ˆåŒ…æ‹¬æ¸¸å®¢ï¼‰å³å¯ä½¿ç”¨
            if (!user.id) {
                // å®Œå…¨æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•æç¤º
                loginRequired.style.display = 'block';
                divinationArea.style.display = 'none';
                featureDesc.style.display = 'none';
            } else {
                // å·²ç™»å½•ï¼ˆæ™®é€šç”¨æˆ·æˆ–æ¸¸å®¢ï¼‰ï¼Œæ˜¾ç¤ºåŠŸèƒ½
                loginRequired.style.display = 'none';
                divinationArea.style.display = 'block';
                featureDesc.style.display = 'block';
                
                // ç®¡ç†å‘˜æ˜¾ç¤ºæ•°æ®å’Œç®¡ç†æŒ‰é’®ï¼Œå¹¶éšè—ä¸šåŠ¡åŠŸèƒ½æŒ‰é’®
                if (user.role === 'admin') {
                    if (dataLink) dataLink.style.display = 'inline-block';
                    if (adminLink) adminLink.style.display = 'inline-block';
                    // éšè—é¦–é¡µã€é—®é“ã€å…­çˆ»ã€åˆç›˜æŒ‰é’®
                    if (homeLink) homeLink.style.display = 'none';
                    if (wendaoLink) wendaoLink.style.display = 'none';
                    if (liuyaoLink) liuyaoLink.style.display = 'none';
                    if (hebanLink) hebanLink.style.display = 'none';
                    authLink.style.display = 'none'; // éšè—ç™»å½•/é€€å‡ºæŒ‰é’®
                } else {
                    // æ™®é€šç”¨æˆ·æˆ–æ¸¸å®¢ï¼Œæ›´æ–°å¯¼èˆªä¸ºé€€å‡º
                    authLink.textContent = 'ğŸšª é€€å‡º';
                    authLink.href = '#';
                    authLink.onclick = function(e) {
                        e.preventDefault();
                        const isGuest = user.isGuest;
                        const confirmMsg = isGuest ? 'é€€å‡ºåå°†æ¸…é™¤å½“å‰ä¼šè¯ï¼Œç¡®å®šè¦é€€å‡ºå—ï¼Ÿ' : 'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ';
                        if (confirm(confirmMsg)) {
                            localStorage.removeItem('wq_user');
                            window.location.href = 'main.html';
                        }
                    };
                }
            }
        })();
    </script>
</body>
</html>