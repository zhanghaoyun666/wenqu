# 问渠 - 用户认证系统设计文档

> **项目状态**: ✅ 已实现 | 🚧 本地演示环境
> 
> **文档目标**: 展示AI产品实习生的用户系统产品设计能力

---

## 一、设计背景

### 1.1 为什么需要用户系统？

在AI产品设计中，用户系统不仅是登录注册功能，更是：
- **数据沉淀的基础**: 保存用户历史记录，提升长期价值
- **商业化的前提**: 会员体系、付费功能的基础
- **运营的工具**: 用户分层、精准运营

### 1.2 设计目标

| 目标 | 说明 | 优先级 |
|------|------|--------|
| 降低使用门槛 | 游客模式免登录体验 | P0 |
| 保证数据安全 | 密码加密、JWT认证 | P0 |
| 区分用户角色 | 普通用户 vs 管理员 | P1 |
| 支持权限控制 | 功能访问权限管理 | P1 |

---

## 二、用户角色设计

### 2.1 角色定义

```
┌─────────────────────────────────────────────────────┐
│                    用户角色体系                       │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌──────────────┐    ┌──────────────┐             │
│  │   普通用户    │    │   管理员      │             │
│  │   (user)     │    │   (admin)    │             │
│  └──────┬───────┘    └──────┬───────┘             │
│         │                    │                     │
│    八字/六爻/合盘        数据看板/用户管理          │
│    查看历史记录          系统统计/权限管理          │
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │              游客 (guest)                    │   │
│  │         免登录体验，数据不保存                │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 2.2 权限矩阵

| 功能 | 游客 | 普通用户 | 管理员 |
|------|:----:|:--------:|:------:|
| 八字测算 | ✅ | ✅ | ❌ |
| 六爻占卜 | ✅ | ✅ | ❌ |
| 合盘分析 | ✅ | ✅ | ❌ |
| 保存历史 | ❌ | ✅ | - |
| 数据看板 | ❌ | ❌ | ✅ |
| 用户管理 | ❌ | ❌ | ✅ |
| 系统统计 | ❌ | ❌ | ✅ |

**设计思考**: 管理员专注于管理和数据分析，不能使用业务功能，避免权限滥用。

---

## 三、用户旅程设计

### 3.1 注册/登录流程

```
新用户旅程:
访问首页 → 点击登录 → 选择注册 → 填写信息 → 注册成功 → 自动登录
              │           │           │           │
              ▼           ▼           ▼           ▼
老用户旅程:
访问首页 → 点击登录 → 输入账号 → 验证成功 → 进入首页
              │           │           │           │
              ▼           ▼           ▼           ▼
游客旅程:
访问首页 → 点击游客体验 → 直接使用 → 提示注册(可选)
```

### 3.2 登录状态保持

**设计决策**: 使用 localStorage + Token 的方式

| 方案 | 优点 | 缺点 | 选择 |
|------|------|------|------|
| Cookie Session | 服务端控制，安全 | 需要维护session状态 | ❌ |
| JWT Token | 无状态，易扩展 | Token泄露风险 | ✅ |
| localStorage | 前端控制，简单 | XSS攻击风险 | ✅ |

**安全措施**:
- Token 设置过期时间（7天）
- 敏感操作需要重新验证
- 退出登录清除所有状态

---

## 四、产品设计细节

### 4.1 登录页设计

**布局结构**:
```
┌─────────────────────────────────────┐
│           Logo + 标题                │
├─────────────────────────────────────┤
│                                     │
│   ┌─────────────────────────────┐   │
│   │      邮箱输入框              │   │
│   └─────────────────────────────┘   │
│                                     │
│   ┌─────────────────────────────┐   │
│   │      密码输入框              │   │
│   └─────────────────────────────┘   │
│                                     │
│   ┌─────────────────────────────┐   │
│   │        登录按钮              │   │
│   └─────────────────────────────┘   │
│                                     │
│   ───────── 或 ─────────            │
│                                     │
│   ┌─────────────────────────────┐   │
│   │      🚀 游客体验             │   │
│   └─────────────────────────────┘   │
│                                     │
│   还没有账号？立即注册 →            │
│                                     │
└─────────────────────────────────────┘
```

### 4.2 导航栏状态变化

| 用户状态 | 显示按钮 | 说明 |
|----------|----------|------|
| 未登录 | 首页、问道、六爻、合盘、登录 | 引导注册 |
| 普通用户 | 首页、问道、六爻、合盘、退出 | 完整功能 |
| 管理员 | 数据、管理、退出 | 管理功能 |

---

## 五、技术实现方案

### 5.1 系统架构

```
┌──────────┐     ┌──────────┐     ┌──────────┐
│  前端页面 │────▶│  API网关  │────▶│  认证服务 │
└──────────┘     └──────────┘     └────┬─────┘
                                         │
                    ┌────────────────────┘
                    ▼
            ┌──────────────┐
            │   Supabase   │
            │   Auth + DB  │
            └──────────────┘
```

### 5.2 核心 API 设计

| 端点 | 方法 | 功能 | 权限 |
|------|------|------|------|
| `/api/auth/register` | POST | 用户注册 | 公开 |
| `/api/auth/login` | POST | 用户登录 | 公开 |
| `/api/auth/me` | GET | 获取当前用户 | 登录用户 |
| `/api/admin/users` | GET | 用户列表 | 仅管理员 |
| `/api/admin/stats` | GET | 统计数据 | 仅管理员 |

### 5.3 数据模型

```sql
-- 用户表
CREATE TABLE app_users (
    id UUID PRIMARY KEY,
    email VARCHAR(255) UNIQUE,
    password_hash VARCHAR(255),
    nickname VARCHAR(100),
    role VARCHAR(20) DEFAULT 'user', -- user/admin
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 六、安全设计

### 6.1 密码安全

- **加密方式**: bcrypt 哈希（盐值 + 多轮加密）
- **密码强度**: 最少6位，建议包含大小写+数字
- **传输安全**: HTTPS 加密传输

### 6.2 会话安全

- **Token 过期**: 7天自动过期
- **刷新机制**: 支持 Token 刷新
- **退出清除**: 退出时清除所有客户端存储

### 6.3 防护机制

| 攻击类型 | 防护措施 |
|----------|----------|
| XSS | 输入过滤、输出转义 |
| CSRF | Token 验证 |
| 暴力破解 | 登录失败限制 |
| 会话劫持 | Token 签名验证 |

---

## 七、快速开始

### 7.1 环境配置

```bash
# 1. 复制环境变量模板
cp env.example .env

# 2. 编辑 .env 文件
SUPABASE_URL=your_supabase_url
SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_KEY=your_service_key
ADMIN_SECRET=your_admin_secret
```

### 7.2 创建管理员账号

```bash
# 一键创建管理员
npm run init-admin
```

### 7.3 验证登录

1. 访问 `http://localhost:3000/auth.html`
2. 使用创建的账号登录
3. 管理员会自动跳转到数据看板

---

## 八、常见问题

### Q: 为什么要区分管理员和普通用户？

**A**: 
- **安全性**: 管理功能涉及敏感数据，需要隔离
- **职责分离**: 管理员专注于数据分析，不参与业务
- **审计追踪**: 便于追踪管理操作

### Q: 游客模式有什么用？

**A**: 
- **降低门槛**: 用户无需注册即可体验
- **转化漏斗**: 先体验再注册，提高转化率
- **数据验证**: 验证产品价值后再收集信息

### Q: 为什么选择 Supabase？

**A**: 
- **快速开发**: 内置Auth，无需自建用户系统
- **成本考虑**: 免费额度足够MVP阶段
- **技术学习**: 了解现代BaaS平台的使用

---

## 九、设计思考总结

### 9.1 关键决策

| 决策 | 选择 | 理由 |
|------|------|------|
| 登录方式 | 邮箱+密码 | 成本低，用户接受度高 |
| 状态保持 | localStorage | 简单，适合MVP |
| 权限模型 | RBAC | 简单清晰，可扩展 |
| 第三方登录 | 暂不实现 | MVP聚焦核心功能 |

### 9.2 可优化方向

- **短信登录**: 提高注册转化率
- **微信登录**: 降低注册门槛
- **多设备同步**: 支持多端登录
- **登录安全**: 异地登录提醒

---

**文档版本**: v1.0  
**撰写**: AI产品实习生  
**最后更新**: 2026年2月

*这个用户认证系统展示了我作为AI产品实习生的产品设计能力：从需求分析到技术方案的完整思考过程。*
