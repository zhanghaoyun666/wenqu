<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆç›˜ - çº¢é¸¾å¤©å–œ | é—®æ¸ </title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="enhanced-animations.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="page-transition">
    <script>
        // æ–°ä¼šè¯æ£€æµ‹ - åˆ·æ–°æˆ–é‡æ–°æ‰“å¼€ç½‘ç«™æ—¶æ¸…é™¤ç™»å½•çŠ¶æ€å¹¶è¿”å›ä¸»ç•Œé¢
        (function() {
            const isNewSession = !sessionStorage.getItem('wq_session_active');
            const isFromOtherPage = document.referrer && document.referrer.includes(window.location.hostname);
            
            if (isNewSession) {
                sessionStorage.setItem('wq_session_active', 'true');
                if (!isFromOtherPage) {
                    localStorage.removeItem('wq_user');
                    localStorage.removeItem('wq_token');
                    window.location.href = 'main.html';
                    return;
                }
            }
            
            // ç®¡ç†å‘˜ä¸èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½
            const user = JSON.parse(localStorage.getItem('wq_user') || '{}');
            if (user.role === 'admin') {
                alert('ç®¡ç†å‘˜è´¦å·æ— æ³•ä½¿ç”¨æ­¤åŠŸèƒ½');
                window.location.href = 'admin.html';
            }
        })();
    </script>
    <div class="bg-decoration"></div>
    
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <header class="header">
            <h1 class="logo glow-text">é—®æ¸ </h1>
            <p class="subtitle">åˆç›˜ Â· çº¢é¸¾å¤©å–œ</p>
        </header>

        <!-- å¯¼èˆª -->
        <nav class="nav">
            <a href="main.html" class="nav-btn" id="homeLink">é¦–é¡µ</a>
            <a href="wendao.html" class="nav-btn" id="wendaoLink">é—®é“</a>
            <a href="liuyao.html" class="nav-btn" id="liuyaoLink">å…­çˆ»</a>
            <a href="heban.html" class="nav-btn active" id="hebanLink">åˆç›˜</a>
            <a href="dashboard.html" class="nav-btn" id="dataLink" style="display: none;">ğŸ“Š æ•°æ®</a>
            <a href="admin.html" class="nav-btn" id="adminLink" style="display: none;">âš™ï¸ ç®¡ç†</a>
            <a href="auth.html" class="nav-btn" id="authLink">ğŸ”‘ ç™»å½•</a>
        </nav>

        <!-- ç™»å½•æ£€æŸ¥æç¤º -->
        <div id="loginRequired" class="card" style="border-color: rgba(255, 100, 100, 0.5); display: none;">
            <h2 class="card-title" style="color: #ff6464;">ğŸ”’ è¯·å…ˆç™»å½•</h2>
            <p style="text-align: center; color: var(--text-secondary); line-height: 2;">
                ä½¿ç”¨åˆç›˜åˆ†æåŠŸèƒ½éœ€è¦å…ˆç™»å½•è´¦å·<br>
                ç™»å½•åå¯ä»¥ä¿å­˜åˆç›˜è®°å½•ï¼Œéšæ—¶æŸ¥çœ‹è¿‡å¾€åˆ†æ
            </p>
            <div style="text-align: center; margin-top: 20px;">
                <a href="auth.html" class="btn">ğŸ”‘ ç«‹å³ç™»å½•</a>
            </div>
        </div>

        <!-- åŠŸèƒ½è¯´æ˜ -->
        <div class="card float-hover" id="featureDesc">
            <h2 class="card-title">ğŸ’• åˆç›˜åˆ†æ</h2>
            <p style="text-align: center; color: var(--text-secondary);">
                çº¢é¸¾å¤©å–œï¼Œæ¸©æŸ”æµªæ¼«çš„å§»ç¼˜ä¹‹ç¥<br>
                åŒäººå…«å­—åŒ¹é…åº¦æµ‹ç®—<br>
                è§£æç¼˜åˆ†æ·±æµ…ï¼Œæä¾›ç›¸å¤„å»ºè®®
            </p>
        </div>

        <!-- è¾“å…¥è¡¨å• -->
        <div class="card float-hover" id="formContainer">
            <h2 class="card-title">ğŸ“ è¾“å…¥åŒæ–¹ç”Ÿè¾°</h2>
            
            <form id="hebanForm">
                <!-- ç”²æ–¹ä¿¡æ¯ -->
                <div style="margin-bottom: 40px;">
                    <h3 style="color: var(--accent-color); margin-bottom: 20px; text-align: center;">ğŸ‘¤ ç”²æ–¹ï¼ˆè‡ªå·±ï¼‰</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">å‡ºç”Ÿå¹´ä»½</label>
                            <input type="number" class="form-input" id="year1" value="2000" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å‡ºç”Ÿæœˆä»½</label>
                            <input type="number" class="form-input" id="month1" min="1" max="12" value="1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å‡ºç”Ÿæ—¥æœŸ</label>
                            <input type="number" class="form-input" id="day1" min="1" max="31" value="1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å‡ºç”Ÿæ—¶è¾°</label>
                            <select class="form-select" id="hour1" required>
                                <option value="0">å­æ—¶ (23:00-01:00)</option>
                                <option value="2">ä¸‘æ—¶ (01:00-03:00)</option>
                                <option value="4">å¯…æ—¶ (03:00-05:00)</option>
                                <option value="6">å¯æ—¶ (05:00-07:00)</option>
                                <option value="8">è¾°æ—¶ (07:00-09:00)</option>
                                <option value="10">å·³æ—¶ (09:00-11:00)</option>
                                <option value="12" selected>åˆæ—¶ (11:00-13:00)</option>
                                <option value="14">æœªæ—¶ (13:00-15:00)</option>
                                <option value="16">ç”³æ—¶ (15:00-17:00)</option>
                                <option value="18">é…‰æ—¶ (17:00-19:00)</option>
                                <option value="20">æˆŒæ—¶ (19:00-21:00)</option>
                                <option value="22">äº¥æ—¶ (21:00-23:00)</option>
                            </select>
                        </div>
                    </div>
                    <div id="baziPreview1" style="display: none;">
                        <div class="bazi-display" id="baziDisplay1"></div>
                    </div>
                </div>

                <!-- ä¹™æ–¹ä¿¡æ¯ -->
                <div style="margin-bottom: 30px;">
                    <h3 style="color: var(--accent-color); margin-bottom: 20px; text-align: center;">ğŸ‘¤ ä¹™æ–¹ï¼ˆå¯¹æ–¹ï¼‰</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">å‡ºç”Ÿå¹´ä»½</label>
                            <input type="number" class="form-input" id="year2" value="2000" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å‡ºç”Ÿæœˆä»½</label>
                            <input type="number" class="form-input" id="month2" min="1" max="12" value="6" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å‡ºç”Ÿæ—¥æœŸ</label>
                            <input type="number" class="form-input" id="day2" min="1" max="31" value="15" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å‡ºç”Ÿæ—¶è¾°</label>
                            <select class="form-select" id="hour2" required>
                                <option value="0">å­æ—¶ (23:00-01:00)</option>
                                <option value="2">ä¸‘æ—¶ (01:00-03:00)</option>
                                <option value="4">å¯…æ—¶ (03:00-05:00)</option>
                                <option value="6">å¯æ—¶ (05:00-07:00)</option>
                                <option value="8" selected>è¾°æ—¶ (07:00-09:00)</option>
                                <option value="10">å·³æ—¶ (09:00-11:00)</option>
                                <option value="12">åˆæ—¶ (11:00-13:00)</option>
                                <option value="14">æœªæ—¶ (13:00-15:00)</option>
                                <option value="16">ç”³æ—¶ (15:00-17:00)</option>
                                <option value="18">é…‰æ—¶ (17:00-19:00)</option>
                                <option value="20">æˆŒæ—¶ (19:00-21:00)</option>
                                <option value="22">äº¥æ—¶ (21:00-23:00)</option>
                            </select>
                        </div>
                    </div>
                    <div id="baziPreview2" style="display: none;">
                        <div class="bazi-display" id="baziDisplay2"></div>
                    </div>
                </div>

                <!-- åˆç›˜é—®é¢˜ -->
                <div class="form-group">
                    <label class="form-label">åˆç›˜é—®é¢˜ï¼ˆå¯é€‰ï¼‰</label>
                    <textarea class="form-textarea" id="userQuestion" placeholder="è¯·è¾“å…¥ä½ æƒ³äº†è§£çš„é—®é¢˜ï¼Œå¦‚ï¼šæˆ‘ä»¬é€‚åˆåœ¨ä¸€èµ·å—ï¼Ÿ"></textarea>
                </div>

                <!-- æäº¤æŒ‰é’® -->
                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn" id="submitBtn">
                        <span id="btnText">ğŸ’• è¯·çº¢é¸¾å¤©å–œåˆç›˜</span>
                    </button>
                </div>
            </form>

            <!-- åŠ è½½åŠ¨ç”» -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p class="loading-text">çº¢é¸¾å¤©å–œæ­£åœ¨åˆç›˜...</p>
            </div>

            <!-- ç»“æœå±•ç¤º -->
            <div class="result-container" id="resultContainer">
                <h3 class="result-title">ğŸ“œ çº¢é¸¾å¤©å–œè°•ç¤º</h3>
                <div class="result-content" id="resultContent"></div>
                <div class="audio-controls" id="audioControls" style="display: none;">
                    <button class="audio-btn" id="playTTSBtn">ğŸ”Š æœ—è¯»ç»“æœ</button>
                </div>
            </div>
        </div>

        <!-- å†å²è®°å½• -->
        <div class="card" id="historyCard" style="display: none;">
            <h2 class="card-title">ğŸ“š å†å²è®°å½•</h2>
            <div class="history-list" id="historyList"></div>
        </div>

        <!-- é¡µè„š -->
        <footer class="footer">
            <p>é—®æ¸  - æ™ºèƒ½å…«å­—å åœå¹³å°</p>
            <p>çº¢é¸¾å¤©å–œä¸ºä½ è§£æå§»ç¼˜</p>
        </footer>
    </div>

    <script src="app.js"></script>
    <script src="analytics.js"></script>
    <script src="enhanced-animations.js"></script>
    <script src="heban-app.js"></script>
    <script>
        // åˆå§‹åŒ–æ•°æ®åˆ†æ
        if (window.Analytics) {
            // å…ˆè®¾ç½®ç”¨æˆ·é‚®ç®±ï¼ˆåœ¨ init ä¹‹å‰ï¼‰
            const user = JSON.parse(localStorage.getItem('wq_user') || '{}');
            console.log('[Heban] User from localStorage:', user);
            if (user.email) {
                console.log('[Heban] Setting email before init:', user.email);
                window.__wq_user_email = user.email;
            }
            
            Analytics.init();
            
            if (user.email) {
                console.log('[Heban] Identifying user:', user.email);
                Analytics.identify(user.email);
            } else {
                console.log('[Heban] No email found in user data');
            }
        }
    </script>
    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        (function() {
            const user = JSON.parse(localStorage.getItem('wq_user') || '{}');
            const loginRequired = document.getElementById('loginRequired');
            const formContainer = document.getElementById('formContainer');
            const featureDesc = document.getElementById('featureDesc');
            const authLink = document.getElementById('authLink');
            const dataLink = document.getElementById('dataLink');
            const adminLink = document.getElementById('adminLink');
            const homeLink = document.getElementById('homeLink');
            const wendaoLink = document.getElementById('wendaoLink');
            const liuyaoLink = document.getElementById('liuyaoLink');
            const hebanLink = document.getElementById('hebanLink');
            
            // æ”¯æŒæ¸¸å®¢æ¨¡å¼ - æœ‰ç”¨æˆ·IDï¼ˆåŒ…æ‹¬æ¸¸å®¢ï¼‰å³å¯ä½¿ç”¨
            if (!user.id) {
                // å®Œå…¨æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•æç¤º
                loginRequired.style.display = 'block';
                formContainer.style.display = 'none';
                featureDesc.style.display = 'none';
            } else {
                // å·²ç™»å½•ï¼ˆæ™®é€šç”¨æˆ·æˆ–æ¸¸å®¢ï¼‰ï¼Œæ˜¾ç¤ºè¡¨å•
                loginRequired.style.display = 'none';
                formContainer.style.display = 'block';
                featureDesc.style.display = 'block';
                
                // ç®¡ç†å‘˜æ˜¾ç¤ºæ•°æ®å’Œç®¡ç†æŒ‰é’®ï¼Œå¹¶éšè—ä¸šåŠ¡åŠŸèƒ½æŒ‰é’®
                if (user.role === 'admin') {
                    if (dataLink) dataLink.style.display = 'inline-block';
                    if (adminLink) adminLink.style.display = 'inline-block';
                    // éšè—é¦–é¡µã€é—®é“ã€å…­çˆ»ã€åˆç›˜æŒ‰é’®
                    if (homeLink) homeLink.style.display = 'none';
                    if (wendaoLink) wendaoLink.style.display = 'none';
                    if (liuyaoLink) liuyaoLink.style.display = 'none';
                    if (hebanLink) hebanLink.style.display = 'none';
                    authLink.style.display = 'none'; // éšè—ç™»å½•/é€€å‡ºæŒ‰é’®
                } else {
                    // æ™®é€šç”¨æˆ·æˆ–æ¸¸å®¢ï¼Œæ›´æ–°å¯¼èˆªä¸ºé€€å‡º
                    authLink.textContent = 'ğŸšª é€€å‡º';
                    authLink.href = '#';
                    authLink.onclick = function(e) {
                        e.preventDefault();
                        const isGuest = user.isGuest;
                        const confirmMsg = isGuest ? 'é€€å‡ºåå°†æ¸…é™¤å½“å‰ä¼šè¯ï¼Œç¡®å®šè¦é€€å‡ºå—ï¼Ÿ' : 'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ';
                        if (confirm(confirmMsg)) {
                            localStorage.removeItem('wq_user');
                            window.location.href = 'main.html';
                        }
                    };
                }
            }
        })();
    </script>
</body>
</html>